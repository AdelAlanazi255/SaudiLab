import React, { createContext, useContext, useEffect, useMemo, useRef, useState } from 'react';


const AuthCtx = createContext(null);

export function AuthProvider({ children }) {
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [subscribed, setSubscribed] = useState(false);

  // prevent overlapping refresh calls
  const refreshingRef = useRef(false);

  const refresh = async () => {
    if (refreshingRef.current) return;
    refreshingRef.current = true;

    setLoading(true);

    const token = getToken();
    if (!token) {
      setUser(null);
      setSubscribed(false);
      setLoading(false);
      refreshingRef.current = false;
      return;
    }

    try {
      const me = await getMe();
      setUser(me.user);

      const sub = await api('/billing/status');
      setSubscribed(!!sub.subscribed);
    } catch (e) {
      clearToken();
      setUser(null);
      setSubscribed(false);
    } finally {
      setLoading(false);
      refreshingRef.current = false;
    }
  };

  // initial load
  useEffect(() => {
    refresh();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ✅ refresh when token changes (login/signup in another tab OR same tab)
  useEffect(() => {
    const onStorage = (e) => {
      // if token changes, refresh
      if (e.key === 'saudilab_token_v1') refresh();
      // if subscription flag changes (optional), refresh too
      if (e.key === 'saudilab_subscription_v1') refresh();
    };

    window.addEventListener('storage', onStorage);

    // ✅ when user comes back to the tab, refresh (common after payment redirect)
    const onFocus = () => refresh();
    window.addEventListener('focus', onFocus);

    return () => {
      window.removeEventListener('storage', onStorage);
      window.removeEventListener('focus', onFocus);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const value = useMemo(
    () => ({
      loading,
      user,
      isLoggedIn: !!user,
      subscribed,
      refresh,
      logout: () => {
        clearToken();
        setUser(null);
        setSubscribed(false);
        window.location.href = '/';
      },
    }),
    [loading, user, subscribed]
  );

  return <AuthCtx.Provider value={value}>{children}</AuthCtx.Provider>;
}

export function useAuth() {
  return useContext(AuthCtx);
}
